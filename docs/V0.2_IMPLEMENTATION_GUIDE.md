# üìò Guide d'Impl√©mentation - WealthTracker v0.2

## üéØ Objectif

Passer de la **v0.1** (transactions textuelles simples) √† la **v0.2** (gestion compl√®te d'actifs financiers).

### Contexte

- **v0.1** : Transactions avec champ `label` (texte libre) et `amount`
- **v0.2** : Syst√®me structur√© avec **Cat√©gories** ‚Üí **Actifs** ‚Üí **Transactions**

---

## üìã Instructions d'Impl√©mentation

### 1Ô∏è‚É£ Mise √† jour du Sch√©ma Prisma

**Fichier** : `prisma/schema.prisma`

#### Ajouter le mod√®le `Category`

```prisma
model Category {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  color  String  @default("#4CAF50") // Couleur hex pour l'UI
  assets Asset[] // Relation one-to-many
}
```

**Champs** :

- `id` : Cl√© primaire auto-incr√©ment√©e
- `name` : Nom unique de la cat√©gorie (ex: "Actions", "Crypto")
- `color` : Couleur hexad√©cimale pour l'affichage (d√©faut vert)
- `assets` : Relation vers les actifs de cette cat√©gorie

---

#### Ajouter le mod√®le `Asset`

```prisma
model Asset {
  id           Int           @id @default(autoincrement())
  name         String        // Nom complet (ex: "Apple Inc.")
  ticker       String        @unique // Symbole boursier (ex: "AAPL")
  currentPrice Float         @default(0) // Prix actuel
  categoryId   Int           // Cl√© √©trang√®re vers Category
  category     Category      @relation(fields: [categoryId], references: [id])
  transactions Transaction[] // Relation one-to-many
  createdAt    DateTime      @default(now())
}
```

**Champs** :

- `id` : Cl√© primaire
- `name` : Nom complet de l'actif (ex: "Apple Inc.")
- `ticker` : Symbole unique (ex: "AAPL", "BTC")
- `currentPrice` : Prix actuel (peut √™tre mis √† jour)
- `categoryId` : Lien vers la cat√©gorie parente
- `category` : Relation Prisma
- `transactions` : Liste des transactions li√©es
- `createdAt` : Date de cr√©ation

---

#### Modifier le mod√®le `Transaction`

**Avant (v0.1)** :

```prisma
model Transaction {
  id        Int      @id @default(autoincrement())
  label     String   // ‚ùå √Ä SUPPRIMER
  amount    Float    // ‚ùå √Ä SUPPRIMER
  date      DateTime @default(now())
  createdAt DateTime @default(now())
}
```

**Apr√®s (v0.2)** :

```prisma
model Transaction {
  id           Int      @id @default(autoincrement())
  assetId      Int      // ‚úÖ NOUVEAU : Relation vers Asset
  asset        Asset    @relation(fields: [assetId], references: [id])
  type         String   // ‚úÖ NOUVEAU : 'BUY' ou 'SELL'
  quantity     Float    // ‚úÖ NOUVEAU : Nombre d'unit√©s
  pricePerUnit Float    // ‚úÖ NOUVEAU : Prix unitaire
  fee          Float    @default(0) // ‚úÖ NOUVEAU : Frais de transaction
  date         DateTime @default(now())
  createdAt    DateTime @default(now())
}
```

**Nouveaux champs** :

- `assetId` : ID de l'actif concern√© (obligatoire)
- `asset` : Relation Prisma vers Asset
- `type` : Type de transaction ("BUY" pour achat, "SELL" pour vente)
- `quantity` : Quantit√© achet√©e/vendue (ex: 10 actions, 0.5 BTC)
- `pricePerUnit` : Prix unitaire au moment de la transaction
- `fee` : Frais de courtage/transaction (d√©faut 0)

**Champs supprim√©s** :

- ‚ùå `label` : Remplac√© par la relation `asset`
- ‚ùå `amount` : Remplac√© par calcul `quantity * pricePerUnit + fee`

---

### 2Ô∏è‚É£ Cr√©er la Migration SQL

**‚ö†Ô∏è IMPORTANT** : Le sch√©ma change drastiquement. Il faut recr√©er la base de donn√©es.

#### Option A : Supprimer et recr√©er (recommand√© pour dev)

```bash
# 1. Supprimer l'ancienne base et migrations
Remove-Item "prisma\dev.db" -Force
Remove-Item "prisma\migrations" -Recurse -Force

# 2. Cr√©er la nouvelle migration
npx prisma migrate dev --name init_v0_2_assets_structure
```

#### Option B : Migration progressive (production)

```bash
# Cr√©er le fichier de migration sans l'appliquer
npx prisma migrate dev --create-only --name add_assets_structure

# Modifier manuellement le fichier SQL g√©n√©r√©
# Puis appliquer
npx prisma migrate dev
```

**R√©sultat attendu** :

```
‚úÖ Migration "init_v0_2_assets_structure" applied
‚úÖ Database schema updated
‚úÖ Prisma Client generated
```

---

### 3Ô∏è‚É£ Mise √† jour du Backend (IPC Handlers)

**Fichier** : `src/main/index.ts`

#### Nouveaux handlers pour les Cat√©gories

```typescript
// ==================== CATEGORIES ====================
ipcMain.handle('category:getAll', async () => {
  try {
    const prisma = getPrismaClient()
    return await prisma.category.findMany({
      orderBy: { name: 'asc' }
    })
  } catch (error) {
    console.error('[IPC] Error fetching categories:', error)
    throw error
  }
})

ipcMain.handle('category:create', async (_, data: { name: string; color: string }) => {
  try {
    const prisma = getPrismaClient()
    return await prisma.category.create({
      data: {
        name: data.name,
        color: data.color
      }
    })
  } catch (error) {
    console.error('[IPC] Error creating category:', error)
    throw error
  }
})
```

#### Nouveaux handlers pour les Actifs

```typescript
// ==================== ASSETS ====================
ipcMain.handle('asset:getAll', async () => {
  try {
    const prisma = getPrismaClient()
    return await prisma.asset.findMany({
      include: { category: true },
      orderBy: { name: 'asc' }
    })
  } catch (error) {
    console.error('[IPC] Error fetching assets:', error)
    throw error
  }
})

ipcMain.handle(
  'asset:create',
  async (_, data: { name: string; ticker: string; currentPrice: number; categoryId: number }) => {
    try {
      const prisma = getPrismaClient()
      return await prisma.asset.create({
        data: {
          name: data.name,
          ticker: data.ticker,
          currentPrice: data.currentPrice,
          categoryId: data.categoryId
        },
        include: { category: true }
      })
    } catch (error) {
      console.error('[IPC] Error creating asset:', error)
      throw error
    }
  }
)
```

#### Mise √† jour du handler Transaction

**Avant (v0.1)** :

```typescript
ipcMain.handle(
  'transaction:create',
  async (_, data: { label: string; amount: number; date: Date }) => {
    // ...
  }
)
```

**Apr√®s (v0.2)** :

```typescript
ipcMain.handle(
  'transaction:create',
  async (
    _,
    data: {
      assetId: number
      type: 'BUY' | 'SELL'
      quantity: number
      pricePerUnit: number
      fee: number
      date: Date
    }
  ) => {
    try {
      const prisma = getPrismaClient()
      return await prisma.transaction.create({
        data: {
          assetId: data.assetId,
          type: data.type,
          quantity: data.quantity,
          pricePerUnit: data.pricePerUnit,
          fee: data.fee || 0,
          date: new Date(data.date)
        },
        include: {
          asset: {
            include: { category: true }
          }
        }
      })
    } catch (error) {
      console.error('[IPC] Error creating transaction:', error)
      throw error
    }
  }
)
```

**Changements** :

- ‚úÖ `assetId` au lieu de `label`
- ‚úÖ `type`, `quantity`, `pricePerUnit`, `fee` ajout√©s
- ‚úÖ `include` pour r√©cup√©rer l'actif et sa cat√©gorie

---

### 4Ô∏è‚É£ Mise √† jour du Frontend

#### A. Mise √† jour des Types TypeScript

**Fichier** : `src/renderer/src/types/index.ts`

```typescript
export interface Category {
  id: number
  name: string
  color: string
}

export interface Asset {
  id: number
  name: string
  ticker: string
  currentPrice: number
  categoryId: number
  category?: Category
  createdAt: Date
}

export interface Transaction {
  id: number
  assetId: number
  asset?: Asset
  type: 'BUY' | 'SELL'
  quantity: number
  pricePerUnit: number
  fee: number
  date: Date
  createdAt: Date
}

export interface TransactionFormData {
  assetId: number
  type: 'BUY' | 'SELL'
  quantity: number
  pricePerUnit: number
  fee: number
  date: Date
}
```

---

#### B. Mise √† jour de l'API Preload

**Fichier** : `src/preload/index.ts`

```typescript
const api = {
  // Transactions
  getAllTransactions: () => ipcRenderer.invoke('transaction:getAll'),
  createTransaction: (data: {
    assetId: number
    type: 'BUY' | 'SELL'
    quantity: number
    pricePerUnit: number
    fee: number
    date: Date
  }) => ipcRenderer.invoke('transaction:create', data),

  // Categories
  getAllCategories: () => ipcRenderer.invoke('category:getAll'),
  createCategory: (data: { name: string; color: string }) =>
    ipcRenderer.invoke('category:create', data),

  // Assets
  getAllAssets: () => ipcRenderer.invoke('asset:getAll'),
  createAsset: (data: { name: string; ticker: string; currentPrice: number; categoryId: number }) =>
    ipcRenderer.invoke('asset:create', data)
}
```

---

#### C. Modification du Formulaire de Transaction

**Fichier** : `src/renderer/src/components/TransactionForm.tsx`

**Changements cl√©s** :

1. **Remplacer le champ `label` (texte) par un `<select>` d'actifs** :

```tsx
// ‚ùå AVANT (v0.1)
<input
  type="text"
  value={formData.label}
  placeholder="Ex: Achat actions Apple"
/>

// ‚úÖ APR√àS (v0.2)
<select
  value={formData.assetId}
  onChange={(e) => setFormData({ ...formData, assetId: parseInt(e.target.value) })}
>
  <option value="">-- S√©lectionner un actif --</option>
  {assets.map((asset) => (
    <option key={asset.id} value={asset.id}>
      {asset.ticker} - {asset.name}
    </option>
  ))}
</select>
```

2. **Ajouter le champ `type` (BUY/SELL)** :

```tsx
<select
  value={formData.type}
  onChange={(e) => setFormData({ ...formData, type: e.target.value as 'BUY' | 'SELL' })}
>
  <option value="BUY">Achat (BUY)</option>
  <option value="SELL">Vente (SELL)</option>
</select>
```

3. **Remplacer `amount` par `quantity` et `pricePerUnit`** :

```tsx
// Quantit√©
<input
  type="number"
  step="0.001"
  value={formData.quantity}
  onChange={(e) => setFormData({ ...formData, quantity: e.target.value })}
  placeholder="Ex: 10"
/>

// Prix unitaire
<input
  type="number"
  step="0.01"
  value={formData.pricePerUnit}
  onChange={(e) => setFormData({ ...formData, pricePerUnit: e.target.value })}
  placeholder="Ex: 195.50"
/>

// Frais (optionnel)
<input
  type="number"
  step="0.01"
  value={formData.fee}
  onChange={(e) => setFormData({ ...formData, fee: e.target.value })}
  placeholder="Ex: 5.00"
/>
```

4. **Charger la liste des actifs au montage** :

```tsx
const [assets, setAssets] = useState<Asset[]>([])

useEffect(() => {
  loadAssets()
}, [])

const loadAssets = async () => {
  const data = await window.api.getAllAssets()
  setAssets(data)
}
```

5. **Validation : v√©rifier qu'un actif existe** :

```tsx
if (!formData.assetId) {
  onError('Veuillez s√©lectionner un actif')
  return
}

if (assets.length === 0) {
  onError('Aucun actif disponible. Cr√©ez-en un dans Configuration.')
  return
}
```

---

#### D. Cr√©er une Page Configuration (TODO pour v0.3)

**Objectif** : Permettre √† l'utilisateur de cr√©er des cat√©gories et des actifs sans passer par le seed.

**Structure √† cr√©er** :

```
src/renderer/src/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ TransactionsPage.tsx  // Page actuelle
‚îÇ   ‚îî‚îÄ‚îÄ SettingsPage.tsx      // ‚úÖ NOUVELLE PAGE
‚îî‚îÄ‚îÄ components/
    ‚îú‚îÄ‚îÄ CategoryForm.tsx      // ‚úÖ NOUVEAU
    ‚îú‚îÄ‚îÄ CategoryList.tsx      // ‚úÖ NOUVEAU
    ‚îú‚îÄ‚îÄ AssetForm.tsx         // ‚úÖ NOUVEAU
    ‚îî‚îÄ‚îÄ AssetList.tsx         // ‚úÖ NOUVEAU
```

**Navigation** (exemple avec onglets) :

```tsx
function App() {
  const [activeTab, setActiveTab] = useState('transactions')

  return (
    <div>
      <nav>
        <button onClick={() => setActiveTab('transactions')}>Transactions</button>
        <button onClick={() => setActiveTab('settings')}>Configuration</button>
      </nav>

      {activeTab === 'transactions' && <TransactionsPage />}
      {activeTab === 'settings' && <SettingsPage />}
    </div>
  )
}
```

**SettingsPage.tsx** (structure) :

```tsx
function SettingsPage() {
  return (
    <div>
      <h2>Configuration</h2>

      <section>
        <h3>Cat√©gories</h3>
        <CategoryForm />
        <CategoryList />
      </section>

      <section>
        <h3>Actifs</h3>
        <AssetForm />
        <AssetList />
      </section>
    </div>
  )
}
```

---

## üìä R√©capitulatif des Changements

| √âl√©ment                | Avant (v0.1)                | Apr√®s (v0.2)                                     |
| ---------------------- | --------------------------- | ------------------------------------------------ |
| **Mod√®les Prisma**     | 1 (Transaction)             | 3 (Category, Asset, Transaction)                 |
| **Champs Transaction** | label, amount, date         | assetId, type, quantity, pricePerUnit, fee, date |
| **IPC Handlers**       | 2 (get/create transactions) | 6 (+ categories + assets)                        |
| **Formulaire**         | 3 champs                    | 6 champs (avec select)                           |
| **Type de donn√©es**    | Texte libre                 | Structur√© (actifs financiers)                    |

---

## ‚úÖ Checklist d'Impl√©mentation

### Phase 1 : Base de donn√©es

- [x] Modifier `prisma/schema.prisma`
  - [x] Ajouter mod√®le `Category`
  - [x] Ajouter mod√®le `Asset`
  - [x] Modifier mod√®le `Transaction`
- [x] Supprimer ancienne DB : `Remove-Item prisma\dev.db`
- [x] Cr√©er migration : `npx prisma migrate dev --name init_v0_2_assets_structure`
- [x] Mettre √† jour `prisma/seed.ts` avec donn√©es de test
- [x] Ex√©cuter seed : `npm run db:seed`

### Phase 2 : Backend

- [x] Mettre √† jour types dans `src/preload/index.d.ts`
- [x] Mettre √† jour API dans `src/preload/index.ts`
- [x] Ajouter handlers IPC dans `src/main/index.ts`
  - [x] `category:getAll` et `category:create`
  - [x] `asset:getAll` et `asset:create`
  - [x] Modifier `transaction:create`

### Phase 3 : Frontend

- [x] Mettre √† jour types dans `src/renderer/src/types/index.ts`
- [x] Modifier `TransactionForm.tsx`
  - [x] Remplacer input `label` par select `assetId`
  - [x] Ajouter select `type` (BUY/SELL)
  - [x] Remplacer `amount` par `quantity` + `pricePerUnit`
  - [x] Ajouter champ `fee`
  - [x] Charger la liste des actifs
  - [x] Validation actif requis
- [x] Modifier `TransactionList.tsx`
  - [x] Afficher ticker + nom de l'actif
  - [x] Badge BUY/SELL
  - [x] D√©tails enrichis
- [x] Mettre √† jour `App.tsx`

### Phase 4 : Configuration (v0.3)

- [ ] Cr√©er `SettingsPage.tsx`
- [ ] Cr√©er `CategoryForm.tsx` et `CategoryList.tsx`
- [ ] Cr√©er `AssetForm.tsx` et `AssetList.tsx`
- [ ] Ajouter syst√®me de navigation (onglets ou router)

---

## üöÄ Commandes Importantes

```bash
# Supprimer l'ancienne base
Remove-Item "prisma\dev.db" -Force
Remove-Item "prisma\migrations" -Recurse -Force

# Cr√©er la migration v0.2
npx prisma migrate dev --name init_v0_2_assets_structure

# G√©n√©rer le Prisma Client
npx prisma generate

# Peupler avec donn√©es de test
npm run db:seed

# Lancer l'application
npm run dev

# Visualiser la base de donn√©es
npm run db:studio
```

---

## üéØ R√©sultat Attendu

Apr√®s impl√©mentation, l'utilisateur pourra :

1. ‚úÖ **Voir les actifs disponibles** dans le menu d√©roulant
2. ‚úÖ **Cr√©er une transaction BUY/SELL** avec :
   - S√©lection de l'actif (ex: AAPL)
   - Type (Achat ou Vente)
   - Quantit√© (ex: 10 actions)
   - Prix unitaire (ex: 195.50 ‚Ç¨)
   - Frais optionnels (ex: 5.00 ‚Ç¨)
   - Date
3. ‚úÖ **Voir les transactions enrichies** avec :
   - Nom et ticker de l'actif
   - Badge color√© BUY/SELL
   - D√©tails de la transaction
   - Montant total calcul√©

**Limitation actuelle** : Pour ajouter des cat√©gories et actifs, il faut passer par le seed. La page Configuration sera d√©velopp√©e en v0.3.

---

## üìö Ressources

- [Prisma Relations](https://www.prisma.io/docs/concepts/components/prisma-schema/relations)
- [Prisma Migrations](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [Electron IPC](https://www.electronjs.org/docs/latest/api/ipc-main)
- [React Select](https://react.dev/reference/react-dom/components/select)
